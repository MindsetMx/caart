<sidebar-layout>
  <div class="px-4 sm:px-6 lg:px-8">
    <div class="sm:flex sm:items-center">
      <h1 class="text-base font-semibold leading-6 text-gray-900 mb-4">Agregar historia del auto</h1>
      <!-- <div class="mt-4 sm:ml-16 sm:mt-0 sm:flex-none">
        <button type="button"
          class="block rounded-md bg-indigo-600 px-3 py-2 text-center text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">Add
          user</button>
      </div> -->
    </div>

    <section class="no-tailwindcss-base">
      <form [formGroup]="addCarHistoryForm" (ngSubmit)="addCarHistory()" class="space-y-6">
        <div>
          <!-- seleccionar fotos de la galería -->
          <!-- <button type="button" (click)="openCarPhotoGallery()" class="block mb-1 text-sm">
            <span class="text-blue-500">Seleccionar fotos de la galería</span>
          </button> -->

          <button (click)="openAuctionCarDetailsModal()" class="block mb-1 text-sm text-blue-500">
            Ver detalles del auto
          </button>

          <div formArrayName="blocks" class="space-y-4 mb-4">
            @for (block of blocksFormArrayControls; track block; let i = $index) {
            <div [formGroupName]="i">
              @switch (block.value.type) {
              @case ('text') {
              <!-- delete button -->
              <div class="flex gap-x-2">
                <textarea formControlName="content" cols="30" rows="10" sharedInput></textarea>

                <button (click)="deleteBlock(i)">
                  <mat-icon class="text-3xl size-10">delete</mat-icon>
                </button>
              </div>

              @if(hasError('content', block)) {
              <shared-input-error [message]="getError('content', block)"></shared-input-error>
              }
              }
              @case ('image') {
              <img [src]="block.value.content" class="object-contain w-fit md:w-96 inline">
              <button (click)="deleteBlock(i)">
                <mat-icon class="text-3xl size-10">delete</mat-icon>
              </button>
              }
              }
            </div>
            }
          </div>

          <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Botón para agregar contenido" type="button">
            <mat-icon class="text-3xl size-10">add_circle</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button (click)="addContent('text')" mat-menu-item>
              <span>Párrafo</span>
            </button>
            <button (click)="openCarPhotoGallery()" mat-menu-item>
              <span>Imagen</span>
            </button>
          </mat-menu>

          @if (hasError('blocks')) {
          <shared-input-error [message]="getError('blocks')"></shared-input-error>
          }
        </div>

        <!-- Extract textarea-->
        <div>
          <label for="extract" class="block mb-1 text-sm">Extracto</label>
          <textarea formControlName="extract" class="w-full h-40" sharedInput></textarea>
          @if (hasError('extract')) {
          <shared-input-error [message]="getError('extract')"></shared-input-error>
          }
        </div>

        <!-- extraInfo -->
        <div>
          <label for="extraInfo" class="block mb-1 text-sm">Información extra</label>
          <textarea formControlName="extraInfo" class="w-full h-40" sharedInput></textarea>
          @if (hasError('extraInfo')) {
          <shared-input-error [message]="getError('extraInfo')"></shared-input-error>
          }
        </div>

        <button class="inline-flex justify-center items-center" type="submit"
          [disabled]="addCarHistorySubmitButtonIsDisabled()" [class.opacity-50]="addCarHistorySubmitButtonIsDisabled()"
          sharedPrimaryButton>
          @if (addCarHistorySubmitButtonIsDisabled()) {
          <shared-spinner></shared-spinner>
          } @else {
          Agregar historia del auto
          }
        </button>
      </form>
    </section>
  </div>

</sidebar-layout>

<car-photo-gallery [isOpen]="carPhotoGalleryIsOpen()" (isOpenChange)="closeCarPhotoGallery()" [cropImage]="true"
  (selectedImageChange)="setImage($event)" [auctionCarId]="originalAuctionCarId()">
</car-photo-gallery>

<auction-car-details-modal [isOpen]="auctionCarDetailsModalIsOpen()" (isOpenChange)="closeAuctionCarDetailsModal()"
  [auctionCarId]="originalAuctionCarId()"></auction-car-details-modal>

<!-- <crop-car-history-image-modal [isOpen]="cropCarHistoryImageModalIsOpen()"
  (isOpenChange)="closeCropCarHistoryImageModal()">
</crop-car-history-image-modal> -->